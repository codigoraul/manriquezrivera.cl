---
import { getServicesByType, getFeaturedImage } from '../lib/wordpress';

interface Props {
  tipo: 'empresas' | 'personas';
  limit?: number;
  showTitle?: boolean;
}

const { tipo, limit, showTitle = true } = Astro.props;

// Obtener servicios filtrados por tipo
const services = await getServicesByType(tipo, limit);

const sanitizeExcerpt = (html: string = '') =>
  html
    .replace(/<[^>]*>/g, ' ')
    .replace(/&nbsp;/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/\s+/g, ' ')
    .trim();

const getExcerptText = (service: any, maxLength = 180) => {
  const raw = service?.excerpt?.rendered || service?.content?.rendered || '';
  const clean = sanitizeExcerpt(raw);
  if (!clean) return '';

  if (clean.length <= maxLength) return clean;

  const trimmed = clean.slice(0, maxLength);
  const lastSpace = trimmed.lastIndexOf(' ');
  return `${trimmed.slice(0, lastSpace > 0 ? lastSpace : maxLength).trim()}…`;
};

const titles = {
  empresas: 'Soluciones para Empresas',
  personas: 'Servicios para Personas'
};
---

<section class="py-16 bg-gray-50">
  <div class="max-w-container mx-auto px-6">
    {showTitle && (
      <div class="text-center mb-12">
        <h2 class="text-[#1A1A1A] text-2xl md:text-3xl lg:text-[38px] font-bold leading-tight mb-4">
          {titles[tipo]}
        </h2>
        <div class="w-24 h-1 bg-secondary mx-auto"></div>
      </div>
    )}

    {services.length === 0 ? (
      <p class="text-center text-gray-600">
        No hay servicios disponibles en esta categoría.
      </p>
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {services.map((service) => {
          const featuredImage = getFeaturedImage(service);
          const serviceUrl = `/servicios/${service.slug}`;
          const excerpt = getExcerptText(service);
          
          return (
            <article class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 group">
              {/* Imagen */}
              <a href={serviceUrl} class="relative block h-64 overflow-hidden" aria-label={`Ver detalle de ${service.title.rendered}`}>
                <img 
                  src={featuredImage}
                  alt={service.title.rendered}
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
              </a>

              {/* Contenido */}
              <div class="p-6">
                <a href={serviceUrl} class="block">
                  <h3 class="text-2xl font-bold text-primary mb-3 group-hover:text-primary-light transition-colors">
                    {service.title.rendered}
                  </h3>
                </a>
                
                {excerpt && (
                  <p class="text-gray-600 mb-4 line-clamp-3">
                    {excerpt}
                  </p>
                )}

                <a 
                  href={serviceUrl}
                  class="inline-flex items-center text-secondary font-semibold hover:text-secondary-dark transition-colors group"
                >
                  Leer más
                  <svg 
                    class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform" 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                  >
                    <path 
                      stroke-linecap="round" 
                      stroke-linejoin="round" 
                      stroke-width="2" 
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </a>
              </div>
            </article>
          );
        })}
      </div>
    )}

    {/* Botón para ver todos (solo si hay límite) */}
    {limit && services.length >= limit && (
      <div class="text-center mt-12">
        <a 
          href={`/servicios-${tipo}`}
          class="inline-block px-8 py-4 bg-primary text-white font-semibold rounded-lg hover:bg-primary-light transition-all duration-300 hover:scale-105 shadow-lg"
        >
          Ver todos los servicios {tipo === 'empresas' ? 'para empresas' : 'para personas'}
        </a>
      </div>
    )}
  </div>
</section>
